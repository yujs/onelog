(function () {
  'use strict';

  function request(data) {
    console.log("event:", data);
    var url = "https://onelog.cc/event";
    var xhr = new XMLHttpRequest();
    xhr.responseType = "json";

    xhr.onreadystatechange = function () {};

    xhr.open("POST", url, true);
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.send(data);
  }

  var Client = function () {
    function Client(options) {
      this.setup();
    }

    Client.prototype.setup = function () {
      this.watch();
    };

    Client.prototype.onpushstatechange = function (callback) {
      var bindEventListener = function bindEventListener(type) {
        var historyEvent = history[type];
        return function () {
          var newEvent = historyEvent.apply(this, arguments);
          var e = new Event(type);
          e.arguments = arguments;
          window.dispatchEvent(e);
          return newEvent;
        };
      };

      history.pushState = bindEventListener("pushState");
      window.addEventListener("pushState", callback);
    };

    Client.prototype.watch = function () {
      var _this = this;

      window.onload = function (e) {
        _this.send(e);
      };

      window.onhashchange = function (e) {
        _this.send(e);
      };

      var self = this;
      this.onpushstatechange(function (e) {
        self.send(e);
      });

      window.onerror = function (e) {
        _this.send(e);
      };

      window.onunload = function (e) {
        _this.send(e);
      };
    };

    Client.prototype.send = function (payload) {
      request(payload);
    };

    return Client;
  }();

  function init(options) {
    new Client(options);
  }

  var current = document.currentScript;
  var appkey = current.getAttribute("appkey");
  init({
    appkey: appkey
  });

})();
